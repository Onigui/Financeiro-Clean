<!doctype html>
<html lang="pt-br">
<head>
<meta charset="utf-8">
<meta name="viewport"="width=device-width, initial-scale=1">
<title>Financeiro PRO ‚Äì Controle Completo de Finan√ßas</title>
<style>
  :root{--bg:#fff;--fg:#0f172a;--muted:#f1f5f9;--muted-fg:#64748b;--border:#e2e8f0;--accent:#2563eb;--success:#16a34a;--warning:#f59e0b;--danger:#dc2626;--ring:rgba(15,23,42,.06)}
  *{box-sizing:border-box} html,body{height:100%} body{margin:0;background:var(--bg);color:var(--fg);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial}
  .container{max-width:1200px;margin:0 auto;padding:16px}
  .topbar{position:sticky;top:0;background:rgba(255,255,255,.95);backdrop-filter:saturate(180%) blur(10px);border-bottom:1px solid var(--border);z-index:20;box-shadow:0 2px 8px rgba(0,0,0,.04)}
  .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}.spacer{flex:1}
  .btn{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--border);padding:8px 12px;border-radius:12px;background:#fff;cursor:pointer;box-shadow:0 8px 20px -12px var(--ring);white-space:nowrap;font-size:13px;transition:all .2s}
  .btn:hover{transform:translateY(-1px);box-shadow:0 12px 24px -12px rgba(0,0,0,.12)} .btn:active{transform:translateY(0)}
  .btn.primary{background:var(--accent);color:#fff;border-color:var(--accent)} 
  .btn.success{background:var(--success);color:#fff;border-color:var(--success)}
  .btn.warning{background:var(--warning);color:#fff;border-color:var(--warning)}
  .btn.danger{background:var(--danger);color:#fff;border-color:var(--danger)}
  .btn.ghost{border-color:transparent;background:transparent;box-shadow:none} 
  .btn.icon{width:36px;height:36px;justify-content:center;padding:0}
  .card{border:1px solid var(--border);border-radius:16px;background:#fff;box-shadow:0 12px 28px -18px var(--ring);position:relative} 
  .card .hd{padding:14px 16px 6px 16px;font-weight:600;display:flex;justify-content:space-between;align-items:center} 
  .card .bd{padding:10px 16px 16px 16px}
  .grid{display:grid;gap:12px} .grid.cols-4{grid-template-columns:repeat(4,minmax(0,1fr))} .grid.cols-3{grid-template-columns:repeat(3,minmax(0,1fr))} .grid.cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}
  @media (max-width:980px){.grid.cols-4{grid-template-columns:repeat(2,minmax(0,1fr))} .grid.cols-3{grid-template-columns:repeat(1,minmax(0,1fr))}} @media (max-width:640px){.grid.cols-4{grid-template-columns:repeat(1,minmax(0,1fr))}}
  .label{font-size:12px;color:var(--muted-fg);margin-bottom:4px;display:block;font-weight:500} .input,.select,.textarea{width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:12px;outline:none;font-family:inherit;font-size:14px}
  .input:focus,.select:focus,.textarea:focus{box-shadow:0 0 0 3px var(--ring);border-color:var(--accent)} 
  .kpi{font-size:22px;font-weight:600} .kpi.large{font-size:28px} .muted{color:var(--muted-fg)} .sep{height:1px;background:var(--border);margin:6px 0}
  table{width:100%;border-collapse:collapse} thead th{background:var(--muted);text-align:left;padding:10px 12px;border-bottom:1px solid var(--border);font-weight:600;font-size:13px} tbody td{padding:10px 12px;border-bottom:1px solid var(--border);font-size:13px}
  tr:hover td{background:#fafafa} .right{text-align:right} 
  .badge{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--border);border-radius:999px;padding:4px 10px;font-size:12px;background:#fff;font-weight:500} 
  .dot{width:10px;height:10px;border-radius:50%;display:inline-block}
  .pilltabs{display:inline-flex;border:1px solid var(--border);padding:4px;border-radius:12px;background:#fff} .pilltabs button{border:0;background:transparent;padding:8px 14px;border-radius:8px;cursor:pointer;font-size:13px;font-weight:500;transition:all .15s} .pilltabs button[data-active="true"]{background:var(--accent);color:#fff}
  .chart{width:100%;height:220px;border:1px solid var(--border);border-radius:12px;display:block}
  dialog{border:1px solid var(--border);border-radius:16px;padding:0;max-width:700px;width:90%;box-shadow:0 24px 48px -12px rgba(0,0,0,.18)}
  dialog::backdrop{background:rgba(0,0,0,.5)} 
  .dlg-hd{padding:20px 24px;border-bottom:1px solid var(--border);font-weight:600;font-size:18px}
  .dlg-bd{padding:20px 24px} .dlg-ft{padding:16px 24px;border-top:1px solid var(--border);display:flex;gap:12px;justify-content:flex-end}
  .alert{padding:12px 16px;border-radius:12px;border:1px solid;margin-bottom:12px;font-size:13px;display:flex;align-items:center;gap:10px}
  .alert.info{background:#eff6ff;border-color:#93c5fd;color:#1e40af}
  .alert.success{background:#f0fdf4;border-color:#86efac;color:#15803d}
  .alert.warning{background:#fffbeb;border-color:#fcd34d;color:#b45309}
  .alert.danger{background:#fef2f2;border-color:#fca5a5;color:#b91c1c}
  .progress-bar{width:100%;height:8px;background:var(--muted);border-radius:999px;overflow:hidden}
  .progress-fill{height:100%;background:var(--accent);transition:width .3s ease;border-radius:999px}
  .tooltip{position:relative;cursor:help;border-bottom:1px dotted var(--muted-fg)}
  .stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:12px}
  .stat-item{text-align:center;padding:12px;background:var(--muted);border-radius:12px}
  .stat-value{font-size:20px;font-weight:600;margin-bottom:4px}
  .stat-label{font-size:11px;color:var(--muted-fg);text-transform:uppercase;letter-spacing:.5px}
  .recurring-badge{background:#eff6ff;color:#1e40af;border-color:#93c5fd;font-size:11px;padding:2px 8px}
</style>
</head>
<body>
  <div class="topbar">
    <div class="container row" style="padding:10px 16px">
      <div class="row" style="gap:10px">
        <strong style="font-size:16px">üí∞ Financeiro PRO</strong>
        <select id="monthPicker" class="select" style="width:180px"></select>
        <button class="btn icon" id="prevMonthBtn" title="M√™s anterior">‚óÄ</button>
        <button class="btn icon" id="nextMonthBtn" title="Pr√≥ximo m√™s">‚ñ∂</button>
      </div>
      <div class="spacer"></div>
      <button class="btn" id="statsBtn" title="Estat√≠sticas e relat√≥rios">üìä Relat√≥rios</button>
      <button class="btn" id="goalsBtn" title="Metas financeiras">üéØ Metas</button>
      <button class="btn" id="recurringBtn" title="Despesas recorrentes">üîÅ Recorrentes</button>
      <button class="btn ghost icon" id="tagsBtn" title="Gerenciar tags">üè∑Ô∏è</button>
      <label class="btn ghost icon" title="Importar dados"><input type="file" id="importJSON" accept="application/json" hidden>üì§</label>
      <button class="btn ghost icon" id="exportBtn" title="Exportar dados">üì•</button>
      <button class="btn ghost icon" id="resetBtn" title="Resetar dados">‚ôªÔ∏è</button>
    </div>
  </div>

  <div class="container" style="margin-top:16px">
    <!-- Alertas -->
    <div id="alertsContainer"></div>

    <!-- KPIs principais -->
    <div class="grid cols-4">
      <div class="card"><div class="hd">Or√ßamento do m√™s</div><div class="bd kpi" id="kpiBudget">R$ 0,00</div></div>
      <div class="card"><div class="hd">Total gasto</div><div class="bd kpi" id="kpiSpent">R$ 0,00</div></div>
      <div class="card"><div class="hd">Saldo restante</div><div class="bd kpi" id="kpiBalance" style="color:var(--success)">R$ 0,00</div></div>
      <div class="card"><div class="hd">Taxa de poupan√ßa</div><div class="bd kpi" id="kpiSavings">0%</div></div>
    </div>

    <!-- Progresso do or√ßamento -->
    <div class="card" style="margin-top:12px">
      <div class="hd">
        <span>Uso do Or√ßamento</span>
        <span id="budgetPercent" class="muted">0%</span>
      </div>
      <div class="bd">
        <div class="progress-bar">
          <div class="progress-fill" id="budgetProgress" style="width:0%"></div>
        </div>
        <div class="row" style="justify-content:space-between;margin-top:8px;font-size:12px">
          <span class="muted">Despesas: <strong id="expenseTotal">R$ 0,00</strong></span>
          <span class="muted">Investimentos: <strong id="investTotal">R$ 0,00</strong></span>
          <span class="muted">Dispon√≠vel: <strong id="availableTotal">R$ 0,00</strong></span>
        </div>
      </div>
    </div>

    <div class="grid cols-3" style="margin-top:12px">
      <!-- Receitas -->
      <div class="card">
        <div class="hd">üíµ Receitas do m√™s</div>
        <div class="bd grid">
          <div><label class="label">Pagamento total</label><input id="inPay" class="input money" inputmode="decimal" placeholder="0,00"></div>
          <div><label class="label">Benef√≠cios</label><input id="inBen" class="input money" inputmode="decimal" placeholder="0,00"></div>
          <div><label class="label">Adicionais</label><input id="inAdd" class="input money" inputmode="decimal" placeholder="0,00"></div>
          <div class="sep"></div>
          <div class="row" style="justify-content:space-between"><span class="muted">Receita total (pr√©via)</span><strong id="inTotal">R$ 0,00</strong></div>
          <div class="row" style="gap:8px"><button class="btn primary" id="confirmIncome">‚úì Confirmar receitas</button><button class="btn ghost" id="clearIncome">Limpar</button></div>
          <div class="muted" style="font-size:11px">üí° Confirme para adicionar ao or√ßamento. Voc√™ pode confirmar v√°rias vezes no m√™s.</div>
        </div>
      </div>

      <!-- Lan√ßar Despesa -->
      <div class="card">
        <div class="hd">üí∏ Lan√ßar despesa</div>
        <div class="bd grid">
          <div><label class="label">Descri√ß√£o *</label><input id="expDesc" class="input" placeholder="Ex.: Mercado, Uber, Aluguel"></div>
          <div class="grid cols-2">
            <div><label class="label">Valor *</label><input id="expVal" class="input money" inputmode="decimal" placeholder="0,00"></div>
            <div><label class="label">Data *</label><input id="expDate" class="input" type="date"></div>
          </div>
          <div><label class="label">Tag</label><select id="expTag" class="select"></select></div>
          <div class="row"><button class="btn success" id="expSubmit">+ Adicionar</button><button class="btn ghost" id="expCancel" style="display:none">Cancelar</button></div>
        </div>
      </div>

      <!-- Resumo R√°pido -->
      <div class="card">
        <div class="hd">üìà Resumo</div>
        <div class="bd">
          <div class="stats-grid">
            <div class="stat-item"><div class="stat-value" id="statExpCount">0</div><div class="stat-label">Despesas</div></div>
            <div class="stat-item"><div class="stat-value" id="statInvCount">0</div><div class="stat-label">Investimentos</div></div>
            <div class="stat-item"><div class="stat-value" id="statAvgExp">R$ 0</div><div class="stat-label">M√©dia/Despesa</div></div>
            <div class="stat-item"><div class="stat-value" id="statDaysLeft">0</div><div class="stat-label">Dias restantes</div></div>
          </div>
          <div class="sep" style="margin:12px 0"></div>
          <label style="display:flex;align-items:center;gap:8px;font-size:13px"><input type="checkbox" id="countInvest" checked> Contar investimentos como despesa</label>
        </div>
      </div>
    </div>

    <!-- Despesas -->
    <div class="card" style="margin-top:12px">
      <div class="hd">
        <div class="row" style="gap:12px;flex:1">
          <span>üí≥ Despesas</span>
          <span class="badge">Total: <strong id="expTableTotal">R$ 0,00</strong></span>
        </div>
        <div class="row" style="gap:8px">
          <select id="filterTag" class="select" style="width:160px"></select>
          <input id="search" class="input" placeholder="üîç Buscar..." style="width:200px">
        </div>
      </div>
      <div class="bd">
        <div style="overflow:auto;border:1px solid var(--border);border-radius:12px;max-height:400px">
          <table><thead><tr><th>Data</th><th>Descri√ß√£o</th><th>Tag</th><th class="right">Valor</th><th></th></tr></thead><tbody id="expTable"></tbody></table>
        </div>
      </div>
    </div>

    <!-- Investimentos -->
    <div class="card" style="margin-top:12px">
      <div class="hd">
        <div class="row" style="gap:12px;flex:1">
          <span>üìä Investimentos</span>
          <span class="badge">Total: <strong id="invTableTotal">R$ 0,00</strong></span>
        </div>
      </div>
      <div class="bd grid">
        <div class="grid cols-3">
          <div><label class="label">Ativo / Descri√ß√£o *</label><input id="invDesc" class="input" placeholder="Ex.: Tesouro Selic, PETR4, BTC"></div>
          <div><label class="label">Categoria</label><select id="invCat" class="select"><option>Renda Fixa</option><option>A√ß√µes</option><option>Fundos</option><option>Cripto</option><option>Poupan√ßa</option><option>Outros</option></select></div>
          <div class="grid cols-2"><div><label class="label">Valor *</label><input id="invVal" class="input money" inputmode="decimal" placeholder="0,00"></div><div><label class="label">Data *</label><input id="invDate" class="input" type="date"></div></div>
        </div>
        <div class="grid cols-2">
          <div><label class="label">Corretora/Conta</label><input id="invBroker" class="input" placeholder="Ex.: Nubank, XP, Binance"></div>
          <div style="display:flex;align-items:flex-end;gap:8px"><button class="btn success" id="invSubmit">+ Adicionar</button><button class="btn ghost" id="invCancel" style="display:none">Cancelar</button></div>
        </div>
        <div class="row" style="gap:8px">
          <select id="filterCat" class="select" style="width:180px"><option value="all">Todas as categorias</option><option>Renda Fixa</option><option>A√ß√µes</option><option>Fundos</option><option>Cripto</option><option>Poupan√ßa</option><option>Outros</option></select>
          <input id="searchInv" class="input" placeholder="üîç Buscar ativo/corretora..." style="width:220px">
        </div>
        <div style="overflow:auto;border:1px solid var(--border);border-radius:12px;max-height:300px">
          <table><thead><tr><th>Data</th><th>Ativo</th><th>Categoria</th><th>Corretora</th><th class="right">Valor</th><th></th></tr></thead><tbody id="invTable"></tbody></table>
        </div>
      </div>
    </div>

    <!-- Gr√°ficos -->
    <div class="grid cols-3" style="margin-top:12px">
      <div class="card"><div class="hd">üìä Comparativo</div><div class="bd"><svg id="chartBars" class="chart" viewBox="0 0 600 220"></svg></div></div>
      <div class="card"><div class="hd">üé® Despesas por Tag</div><div class="bd"><svg id="chartPie" class="chart" viewBox="0 0 220 235" style="height:240px"></svg></div></div>
      <div class="card"><div class="hd">üíé Investimentos por Categoria</div><div class="bd"><svg id="chartPieInv" class="chart" viewBox="0 0 220 235" style="height:240px"></svg></div></div>
    </div>
  </div>

  <!-- Dialog: Tags -->
  <dialog id="dlgTags">
    <div class="dlg-hd">üè∑Ô∏è Administra√ß√£o de Tags</div>
    <div class="dlg-bd grid">
      <div class="grid cols-3">
        <div><label class="label">Nome</label><input id="tagName" class="input" placeholder="Ex.: Mercado, Transporte..."></div>
        <div><label class="label">Cor</label><input id="tagColor" class="input" type="color" value="#2563eb"></div>
        <div style="display:flex;align-items:flex-end"><button class="btn primary" id="tagSave">Salvar</button></div>
      </div>
      <div style="overflow:auto;border:1px solid var(--border);border-radius:12px;max-height:300px">
        <table><thead><tr><th>Tag</th><th>Cor</th><th></th></tr></thead><tbody id="tagTable"></tbody></table>
      </div>
    </div>
    <div class="dlg-ft"><button class="btn" onclick="document.getElementById('dlgTags').close()">Fechar</button></div>
  </dialog>

  <!-- Dialog: Metas -->
  <dialog id="dlgGoals">
    <div class="dlg-hd">üéØ Metas Financeiras</div>
    <div class="dlg-bd grid">
      <div class="grid cols-2">
        <div><label class="label">Descri√ß√£o da meta</label><input id="goalDesc" class="input" placeholder="Ex.: Economizar para viagem"></div>
        <div><label class="label">Valor da meta (R$)</label><input id="goalValue" class="input money" inputmode="decimal" placeholder="0,00"></div>
      </div>
      <div class="grid cols-3">
        <div><label class="label">Prazo (meses)</label><input id="goalMonths" class="input" type="number" min="1" placeholder="Ex.: 6"></div>
        <div><label class="label">Tag relacionada</label><select id="goalTag" class="select"></select></div>
        <div style="display:flex;align-items:flex-end"><button class="btn primary" id="goalSave">Adicionar Meta</button></div>
      </div>
      <div class="sep"></div>
      <div id="goalsList"></div>
    </div>
    <div class="dlg-ft"><button class="btn" onclick="document.getElementById('dlgGoals').close()">Fechar</button></div>
  </dialog>

  <!-- Dialog: Despesas Recorrentes -->
  <dialog id="dlgRecurring">
    <div class="dlg-hd">üîÅ Despesas Recorrentes</div>
    <div class="dlg-bd grid">
      <div class="alert info">üí° Configure suas despesas fixas mensais. Elas ser√£o sugeridas automaticamente a cada m√™s.</div>
      <div class="grid cols-3">
        <div><label class="label">Descri√ß√£o</label><input id="recDesc" class="input" placeholder="Ex.: Aluguel, Internet"></div>
        <div><label class="label">Valor (R$)</label><input id="recValue" class="input money" inputmode="decimal" placeholder="0,00"></div>
        <div><label class="label">Dia do m√™s</label><input id="recDay" class="input" type="number" min="1" max="31" placeholder="Ex.: 10"></div>
      </div>
      <div class="grid cols-2">
        <div><label class="label">Tag</label><select id="recTag" class="select"></select></div>
        <div style="display:flex;align-items:flex-end"><button class="btn primary" id="recSave">Adicionar</button></div>
      </div>
      <div style="overflow:auto;border:1px solid var(--border);border-radius:12px;max-height:250px">
        <table><thead><tr><th>Descri√ß√£o</th><th>Valor</th><th>Dia</th><th>Tag</th><th></th></tr></thead><tbody id="recTable"></tbody></table>
      </div>
    </div>
    <div class="dlg-ft">
      <button class="btn success" id="applyRecurring">Aplicar recorrentes do m√™s</button>
      <button class="btn" onclick="document.getElementById('dlgRecurring').close()">Fechar</button>
    </div>
  </dialog>

  <!-- Dialog: Estat√≠sticas -->
  <dialog id="dlgStats">
    <div class="dlg-hd">üìä Relat√≥rios e Estat√≠sticas</div>
    <div class="dlg-bd grid">
      <div class="grid cols-3">
        <div class="card"><div class="hd">Total de meses</div><div class="bd kpi" id="statTotalMonths">0</div></div>
        <div class="card"><div class="hd">Despesas totais</div><div class="bd kpi" id="statTotalExp">R$ 0,00</div></div>
        <div class="card"><div class="hd">Investimentos totais</div><div class="bd kpi" id="statTotalInv">R$ 0,00</div></div>
      </div>
      <div class="card">
        <div class="hd">Evolu√ß√£o mensal (√∫ltimos 6 meses)</div>
        <div class="bd"><svg id="chartEvolution" class="chart" viewBox="0 0 600 220" style="height:250px"></svg></div>
      </div>
      <div class="grid cols-2">
        <div class="card">
          <div class="hd">Top 5 despesas por tag</div>
          <div class="bd"><div id="topTagsList"></div></div>
        </div>
        <div class="card">
          <div class="hd">Compara√ß√£o com m√™s anterior</div>
          <div class="bd"><div id="comparisonList"></div></div>
        </div>
      </div>
    </div>
    <div class="dlg-ft"><button class="btn" onclick="document.getElementById('dlgStats').close()">Fechar</button></div>
  </dialog>

<script>
(function(){
  const LS_KEY="financeiro_pro_v2";
  const $=(s)=>document.querySelector(s); const $$=(s)=>Array.from(document.querySelectorAll(s));
  
  const defaults=()=>{
    const now=new Date();
    const ym=`${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
    function uid(){return Math.random().toString(36).slice(2,10)}
    return{
      tags:[
        {id:uid(),name:"Alimenta√ß√£o",color:"#16a34a"},
        {id:uid(),name:"Transporte",color:"#2563eb"},
        {id:uid(),name:"Moradia",color:"#ea580c"},
        {id:uid(),name:"Contas",color:"#9333ea"},
        {id:uid(),name:"Lazer",color:"#e11d48"},
        {id:uid(),name:"Sa√∫de",color:"#0ea5e9"}
      ],
      months:{[ym]:{incomeDraft:{payment:0,benefits:0,additions:0},incomeCommitted:0,expenses:[],investments:[]}},
      countInvestAsExpense:true,
      goals:[],
      recurring:[],
      settings:{alertThreshold:80,autoBackup:true}
    };
  };
  
  function load(){
    try{
      const data=JSON.parse(localStorage.getItem(LS_KEY));
      if(!data) return defaults();
      // Migration from v1
      if(!data.goals) data.goals=[];
      if(!data.recurring) data.recurring=[];
      if(!data.settings) data.settings={alertThreshold:80,autoBackup:true};
      return data;
    }catch{return defaults();}
  }
  
  function save(){
    localStorage.setItem(LS_KEY,JSON.stringify(store));
    // Auto backup
    if(store.settings?.autoBackup){
      const backups=JSON.parse(localStorage.getItem(LS_KEY+'_backups')||'[]');
      backups.push({date:new Date().toISOString(),data:JSON.stringify(store)});
      if(backups.length>5) backups.shift();
      localStorage.setItem(LS_KEY+'_backups',JSON.stringify(backups));
    }
  }
  
  const toNumberBR=(s)=>{if(typeof s!=='string')s=String(s??'');s=s.replace(/\./g,'').replace(',','.');const n=parseFloat(s);return isNaN(n)?0:n;};
  const fmt=(n)=>(Number(n)||0).toLocaleString('pt-BR',{style:'currency',currency:'BRL'});
  const fmt2=(n)=>(Number(n)||0).toLocaleString('pt-BR',{minimumFractionDigits:2,maximumFractionDigits:2});
  const fmtShort=(n)=>{n=Number(n)||0;if(n>=1000000)return 'R$ '+(n/1000000).toFixed(1)+'M';if(n>=1000)return 'R$ '+(n/1000).toFixed(1)+'k';return fmt(n);};
  
  let store=load(); 
  let month=Object.keys(store.months).sort().reverse()[0];
  let editingExpId=null, editingTagId=null, editingInvId=null, editingGoalId=null, editingRecId=null;
  
  // Elements
  const monthPicker=$("#monthPicker"), prevMonthBtn=$("#prevMonthBtn"), nextMonthBtn=$("#nextMonthBtn");
  const inPay=$("#inPay"), inBen=$("#inBen"), inAdd=$("#inAdd"), inTotal=$("#inTotal"), confirmIncome=$("#confirmIncome"), clearIncome=$("#clearIncome");
  const kpiBudget=$("#kpiBudget"), kpiSpent=$("#kpiSpent"), kpiBalance=$("#kpiBalance"), kpiSavings=$("#kpiSavings");
  const expDesc=$("#expDesc"), expVal=$("#expVal"), expDate=$("#expDate"), expTag=$("#expTag"), expSubmit=$("#expSubmit"), expCancel=$("#expCancel");
  const filterTag=$("#filterTag"), search=$("#search"), expTable=$("#expTable");
  const invDesc=$("#invDesc"), invCat=$("#invCat"), invVal=$("#invVal"), invDate=$("#invDate"), invBroker=$("#invBroker");
  const invSubmit=$("#invSubmit"), invCancel=$("#invCancel"), filterCat=$("#filterCat"), searchInv=$("#searchInv"), invTable=$("#invTable");
  const countInvest=$("#countInvest");
  const exportBtn=$("#exportBtn"), importJSON=$("#importJSON"), tagsBtn=$("#tagsBtn"), resetBtn=$("#resetBtn");
  const goalsBtn=$("#goalsBtn"), recurringBtn=$("#recurringBtn"), statsBtn=$("#statsBtn");
  const alertsContainer=$("#alertsContainer");
  
  function ensureMonth(ym){if(!store.months[ym]) store.months[ym]={incomeDraft:{payment:0,benefits:0,additions:0},incomeCommitted:0,expenses:[],investments:[]};}
  function current(){return store.months[month]}
  function uid(){return Math.random().toString(36).slice(2,10)}
  function esc(s){return (s||'').replace(/[&<>'"]/g,function(c){return {'&':'&amp;','<':'&lt;','>':'&gt;',"'":'&#39;','"':'&quot;'}[c]||c;});}
  function num(s){const x=String(s).replace(/[^\d,.-]/g,'').replace(/\./g,'').replace(',','.');const n=parseFloat(x);return isNaN(n)?0:n;}
  function formatDateLocal(dateStr){if(!dateStr) return '-';const [y,m,d]=dateStr.split('-').map(Number);return new Date(y,m-1,d).toLocaleDateString('pt-BR');}
  
  function showAlert(message,type='info'){
    const alert=document.createElement('div');
    alert.className=`alert ${type}`;
    alert.innerHTML=`<span>${message}</span><button class="btn ghost" onclick="this.parentElement.remove()" style="margin-left:auto;padding:4px 8px">‚úï</button>`;
    alertsContainer.appendChild(alert);
    setTimeout(()=>alert.remove(),8000);
  }
  
  function checkAlerts(){
    alertsContainer.innerHTML='';
    const budget=current().incomeCommitted;
    if(budget<=0) return;
    const expenses=current().expenses.reduce((s,e)=>s+Number(e.amount||0),0);
    const investments=store.countInvestAsExpense?current().investments.reduce((s,i)=>s+Number(i.amount||0),0):0;
    const spent=expenses+investments;
    const percent=(spent/budget)*100;
    const threshold=store.settings?.alertThreshold||80;
    
    if(percent>=100){
      showAlert('‚ö†Ô∏è ATEN√á√ÉO: Voc√™ excedeu seu or√ßamento mensal!','danger');
    }else if(percent>=threshold){
      showAlert(`‚ö†Ô∏è ALERTA: Voc√™ j√° utilizou ${percent.toFixed(0)}% do seu or√ßamento!`,'warning');
    }
    
    // Check recurring expenses
    const today=new Date();
    const currentMonth=`${today.getFullYear()}-${String(today.getMonth()+1).padStart(2,'0')}`;
    if(month===currentMonth){
      const pending=store.recurring.filter(r=>{
        const hasExpense=current().expenses.some(e=>e.description===r.description && e.amount===r.amount);
        return !hasExpense;
      });
      if(pending.length>0){
        showAlert(`üí° Voc√™ tem ${pending.length} despesa(s) recorrente(s) pendente(s) este m√™s.`,'info');
      }
    }
  }
  
  function renderMonths(){
    const list=Object.keys(store.months);
    if(!list.includes(month)) list.push(month);
    list.sort();
    monthPicker.innerHTML=list.map(ym=>`<option value="${ym}">${new Date(ym+'-01').toLocaleDateString('pt-BR',{month:'long',year:'numeric'})}</option>`).join('');
    monthPicker.value=month;
  }
  
  function addMonth(delta){
    const [y,m]=month.split('-').map(Number);
    const d=new Date(y,m-1+delta,1);
    const ym=`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
    ensureMonth(ym);
    month=ym;
    save();
    refresh(true);
  }
  
  function renderIncome(sync){
    const d=current().incomeDraft;
    const total=Number(d.payment)+Number(d.benefits)+Number(d.additions);
    if(sync){
      inPay.value=fmt2(d.payment);
      inBen.value=fmt2(d.benefits);
      inAdd.value=fmt2(d.additions);
    }
    inTotal.textContent=fmt(total);
  }
  
  function renderTags(){
    const opts=store.tags.map(t=>`<option value="${t.id}">${t.name}</option>`).join('');
    expTag.innerHTML=opts;
    filterTag.innerHTML=`<option value="all">Todas as tags</option>`+opts;
    // For goals and recurring
    const goalTag=$("#goalTag"), recTag=$("#recTag");
    if(goalTag) goalTag.innerHTML='<option value="">Nenhuma</option>'+opts;
    if(recTag) recTag.innerHTML=opts;
  }
  
  function renderExpenses(){
    const q=(search.value||'').trim().toLowerCase();
    const tag=filterTag.value;
    const items=current().expenses.filter(e=>tag==='all'?true:e.tagId===tag)
      .filter(e=>q?(e.description||'').toLowerCase().includes(q):true)
      .sort((a,b)=>new Date(b.date)-new Date(a.date));
    
    expTable.innerHTML=items.map(e=>{
      const t=store.tags.find(x=>x.id===e.tagId);
      const tagHtml=t?`<span class="badge"><span class="dot" style="background:${t.color}"></span>${t.name}</span>`:'<span class="muted">Sem tag</span>';
      const isRecurring=store.recurring.some(r=>r.description===e.description && r.amount===e.amount);
      const recBadge=isRecurring?'<span class="badge recurring-badge">üîÅ Recorrente</span>':'';
      return `<tr>
        <td>${formatDateLocal(e.date)}</td>
        <td>${esc(e.description||'')} ${recBadge}</td>
        <td>${tagHtml}</td>
        <td class="right"><strong>${fmt(e.amount)}</strong></td>
        <td class="right">
          <button class="btn ghost icon" data-edit="${e.id}" title="Editar">‚úèÔ∏è</button>
          <button class="btn ghost icon" data-del="${e.id}" title="Deletar">üóëÔ∏è</button>
        </td>
      </tr>`;
    }).join('')||'<tr><td colspan="5" class="muted" style="text-align:center;padding:20px">Nenhuma despesa lan√ßada.</td></tr>';
    
    expTable.querySelectorAll("[data-edit]").forEach(b=>b.addEventListener('click',()=>{
      const id=b.getAttribute('data-edit');
      const e=current().expenses.find(x=>x.id===id);
      if(!e) return;
      editingExpId=id;
      expDesc.value=e.description;
      expVal.value=fmt2(e.amount);
      expDate.value=e.date;
      expTag.value=e.tagId||"";
      expSubmit.textContent="üíæ Salvar edi√ß√£o";
      expCancel.style.display="inline-flex";
      window.scrollTo({top:0,behavior:'smooth'});
    }));
    
    expTable.querySelectorAll("[data-del]").forEach(b=>b.addEventListener('click',()=>{
      if(!confirm('Deseja realmente excluir esta despesa?')) return;
      const id=b.getAttribute('data-del');
      current().expenses=current().expenses.filter(x=>x.id!==id);
      save();
      refresh(false);
      showAlert('Despesa exclu√≠da com sucesso!','success');
    }));
    
    const total=items.reduce((s,e)=>s+Number(e.amount||0),0);
    $("#expTableTotal").textContent=fmt(total);
    return total;
  }
  
  function renderInvestments(){
    const q=(searchInv.value||'').trim().toLowerCase();
    const cat=filterCat.value;
    const items=current().investments.filter(i=>cat==='all'?true:i.category===cat)
      .filter(i=>q?((i.description||'').toLowerCase().includes(q)||(i.broker||'').toLowerCase().includes(q)):true)
      .sort((a,b)=>new Date(b.date)-new Date(a.date));
    
    invTable.innerHTML=items.map(i=>`<tr>
      <td>${formatDateLocal(i.date)}</td>
      <td>${esc(i.description||'')}</td>
      <td><span class="badge">${esc(i.category||'')}</span></td>
      <td>${esc(i.broker||'-')}</td>
      <td class="right"><strong>${fmt(i.amount)}</strong></td>
      <td class="right">
        <button class="btn ghost icon" data-iedit="${i.id}" title="Editar">‚úèÔ∏è</button>
        <button class="btn ghost icon" data-idel="${i.id}" title="Deletar">üóëÔ∏è</button>
      </td>
    </tr>`).join('')||'<tr><td colspan="6" class="muted" style="text-align:center;padding:20px">Nenhum investimento lan√ßado.</td></tr>';
    
    invTable.querySelectorAll("[data-iedit]").forEach(b=>b.addEventListener('click',()=>{
      const id=b.getAttribute('data-iedit');
      const i=current().investments.find(x=>x.id===id);
      if(!i) return;
      editingInvId=id;
      invDesc.value=i.description;
      invCat.value=i.category;
      invVal.value=fmt2(i.amount);
      invDate.value=i.date;
      invBroker.value=i.broker||"";
      invSubmit.textContent="üíæ Salvar edi√ß√£o";
      invCancel.style.display="inline-flex";
      window.scrollTo({top:0,behavior:'smooth'});
    }));
    
    invTable.querySelectorAll("[data-idel]").forEach(b=>b.addEventListener('click',()=>{
      if(!confirm('Deseja realmente excluir este investimento?')) return;
      const id=b.getAttribute('data-idel');
      current().investments=current().investments.filter(x=>x.id!==id);
      save();
      refresh(false);
      showAlert('Investimento exclu√≠do com sucesso!','success');
    }));
    
    const total=items.reduce((s,i)=>s+Number(i.amount||0),0);
    $("#invTableTotal").textContent=fmt(total);
    return total;
  }
  
  function renderKPIs(){
    const budget=current().incomeCommitted;
    const expenses=current().expenses.reduce((s,e)=>s+Number(e.amount||0),0);
    const investments=current().investments.reduce((s,i)=>s+Number(i.amount||0),0);
    const spent=expenses+(store.countInvestAsExpense?investments:0);
    const balance=budget-spent;
    const savingsRate=budget>0?(balance/budget)*100:0;
    
    kpiBudget.textContent=fmt(budget);
    kpiSpent.textContent=fmt(spent);
    kpiBalance.textContent=fmt(balance);
    kpiBalance.style.color=balance>=0?'var(--success)':'var(--danger)';
    kpiSavings.textContent=savingsRate.toFixed(1)+'%';
    kpiSavings.style.color=savingsRate>=20?'var(--success)':savingsRate>=10?'var(--warning)':'var(--danger)';
    
    // Progress bar
    const percent=budget>0?(spent/budget)*100:0;
    $("#budgetProgress").style.width=Math.min(percent,100)+'%';
    $("#budgetProgress").style.background=percent>=100?'var(--danger)':percent>=80?'var(--warning)':'var(--accent)';
    $("#budgetPercent").textContent=percent.toFixed(1)+'%';
    $("#expenseTotal").textContent=fmt(expenses);
    $("#investTotal").textContent=fmt(investments);
    $("#availableTotal").textContent=fmt(balance);
    
    // Stats
    $("#statExpCount").textContent=current().expenses.length;
    $("#statInvCount").textContent=current().investments.length;
    $("#statAvgExp").textContent=current().expenses.length>0?fmtShort(expenses/current().expenses.length):'R$ 0';
    
    // Days left in month
    const today=new Date();
    const [y,m]=month.split('-').map(Number);
    const lastDay=new Date(y,m,0).getDate();
    const currentDay=month===`${today.getFullYear()}-${String(today.getMonth()+1).padStart(2,'0')}`?today.getDate():lastDay;
    $("#statDaysLeft").textContent=Math.max(0,lastDay-currentDay);
  }
  
  function charts(){
    // Bar chart
    const bars=$("#chartBars");
    while(bars.firstChild) bars.removeChild(bars.firstChild);
    const W=600,H=220,pad=45,innerW=W-pad*2,innerH=H-pad*2;
    
    const budget=current().incomeCommitted;
    const exp=current().expenses.reduce((s,e)=>s+Number(e.amount||0),0);
    const inv=current().investments.reduce((s,i)=>s+Number(i.amount||0),0);
    const maxv=Math.max(1,budget,exp,inv);
    
    // Axis
    const x0=document.createElementNS("http://www.w3.org/2000/svg","line");
    x0.setAttribute("x1",pad);x0.setAttribute("y1",H-pad);x0.setAttribute("x2",W-pad);x0.setAttribute("y2",H-pad);
    x0.setAttribute("stroke","#cbd5e1");x0.setAttribute("stroke-width","2");bars.appendChild(x0);
    
    const labels=["Or√ßamento","Despesas","Investimentos"],vals=[budget,exp,inv],colors=["#2563eb","#ea580c","#16a34a"];
    const barW=innerW/labels.length*0.6;
    
    labels.forEach((lb,i)=>{
      const x=pad+innerW/labels.length*(i+0.5);
      const h=(vals[i]/maxv)*(innerH-15);
      const y=H-pad-h;
      
      const r=document.createElementNS(bars.namespaceURI,"rect");
      r.setAttribute("x",x-barW/2);r.setAttribute("y",y);r.setAttribute("width",barW);r.setAttribute("height",h);
      r.setAttribute("fill",colors[i]);r.setAttribute("rx","4");bars.appendChild(r);
      
      const t=document.createElementNS(bars.namespaceURI,"text");
      t.setAttribute("x",x);t.setAttribute("y",H-pad+20);t.setAttribute("text-anchor","middle");
      t.setAttribute("font-size","14");t.setAttribute("font-weight","600");t.setAttribute("fill","#475569");t.textContent=lb;bars.appendChild(t);
      
      const v=document.createElementNS(bars.namespaceURI,"text");
      v.setAttribute("x",x);v.setAttribute("y",y-8);v.setAttribute("text-anchor","middle");
      v.setAttribute("font-size","15");v.setAttribute("font-weight","700");v.setAttribute("fill","#0f172a");
      v.textContent=fmtShort(vals[i]);bars.appendChild(v);
    });
    
    // Pie charts
    function pie(svgId,entries){
      const svg=$(svgId);
      while(svg.firstChild) svg.removeChild(svg.firstChild);
      const total=entries.reduce((s,[_,v])=>s+v,0);
      const cx=110,cy=90,r=65;
      let a0=-Math.PI/2;
      
      if(!total){
        const c=document.createElementNS(svg.namespaceURI,"circle");
        c.setAttribute("cx",cx);c.setAttribute("cy",cy);c.setAttribute("r",r);
        c.setAttribute("fill","none");c.setAttribute("stroke","#e2e8f0");c.setAttribute("stroke-width","20");
        svg.appendChild(c);
        const t=document.createElementNS(svg.namespaceURI,"text");
        t.setAttribute("x",cx);t.setAttribute("y",cy);t.setAttribute("text-anchor","middle");
        t.setAttribute("font-size","14");t.setAttribute("font-weight","600");t.setAttribute("fill","#94a3b8");t.textContent="Sem dados";
        svg.appendChild(t);
        return;
      }
      
      const colors=["#2563eb","#16a34a","#ea580c","#9333ea","#e11d48","#0ea5e9","#a3e635","#f59e0b","#14b8a6"];
      
      entries.forEach(([label,val],i)=>{
        const a1=a0+(val/total)*Math.PI*2;
        const x0=cx+r*Math.cos(a0),y0=cy+r*Math.sin(a0);
        const x1=cx+r*Math.cos(a1),y1=cy+r*Math.sin(a1);
        const large=(a1-a0)>Math.PI?1:0;
        
        const p=document.createElementNS(svg.namespaceURI,"path");
        p.setAttribute("d",`M ${cx} ${cy} L ${x0} ${y0} A ${r} ${r} 0 ${large} 1 ${x1} ${y1} Z`);
        p.setAttribute("fill",colors[i%colors.length]);
        svg.appendChild(p);
        
        // Percentage label on slice
        const midA=(a0+a1)/2;
        const pctR=r*0.7;
        const px=cx+pctR*Math.cos(midA);
        const py=cy+pctR*Math.sin(midA);
        
        if((val/total)*100>=8){
          const t=document.createElementNS(svg.namespaceURI,"text");
          t.setAttribute("x",px);t.setAttribute("y",py+4);t.setAttribute("text-anchor","middle");
          t.setAttribute("font-size","14");t.setAttribute("font-weight","700");t.setAttribute("fill","#ffffff");
          t.setAttribute("stroke","#000000");t.setAttribute("stroke-width","0.5");t.setAttribute("paint-order","stroke");
          t.textContent=((val/total)*100).toFixed(0)+'%';
          svg.appendChild(t);
        }
        
        a0=a1;
      });
      
      // Legend below
      let legendY=175;
      entries.forEach(([label,val],i)=>{
        const legendX=i%2===0?15:125;
        if(i>0 && i%2===0) legendY+=18;
        
        const rect=document.createElementNS(svg.namespaceURI,"rect");
        rect.setAttribute("x",legendX);rect.setAttribute("y",legendY-10);
        rect.setAttribute("width","12");rect.setAttribute("height","12");
        rect.setAttribute("fill",colors[i%colors.length]);rect.setAttribute("rx","2");
        svg.appendChild(rect);
        
        const text=document.createElementNS(svg.namespaceURI,"text");
        text.setAttribute("x",legendX+16);text.setAttribute("y",legendY);
        text.setAttribute("font-size","11");text.setAttribute("font-weight","500");text.setAttribute("fill","#475569");
        text.textContent=label.length>12?label.substring(0,12)+'...':label;
        svg.appendChild(text);
      });
    }
    
    // Expenses by tag
    const tagTotals={};
    current().expenses.forEach(e=>{
      const t=store.tags.find(x=>x.id===e.tagId);
      const key=t?t.name:'Sem tag';
      tagTotals[key]=(tagTotals[key]||0)+Number(e.amount||0);
    });
    const tagEntries=Object.entries(tagTotals).sort((a,b)=>b[1]-a[1]).slice(0,6);
    pie("#chartPie",tagEntries);
    
    // Investments by category
    const catTotals={};
    current().investments.forEach(i=>{
      const c=i.category||'Outros';
      catTotals[c]=(catTotals[c]||0)+Number(i.amount||0);
    });
    const catEntries=Object.entries(catTotals).sort((a,b)=>b[1]-a[1]).slice(0,6);
    pie("#chartPieInv",catEntries);
  }
  
  function refresh(sync){
    ensureMonth(month);
    renderMonths();
    renderIncome(!!sync);
    renderTags();
    renderExpenses();
    renderInvestments();
    renderKPIs();
    charts();
    checkAlerts();
  }
  
  // Event listeners
  monthPicker.addEventListener('change',e=>{month=e.target.value;save();refresh(true)});
  prevMonthBtn.addEventListener('click',()=>addMonth(-1));
  nextMonthBtn.addEventListener('click',()=>addMonth(1));
  
  // Money inputs
  const moneyInputs=[inPay,inBen,inAdd,expVal,invVal];
  moneyInputs.forEach(el=>{
    el.addEventListener('input',()=>{
      let v=el.value.replace(/[^\d.,]/g,'');
      v=v.replace(/\./g,',');
      el.value=v;
      const d=current().incomeDraft;
      if(el===inPay) d.payment=toNumberBR(v);
      if(el===inBen) d.benefits=toNumberBR(v);
      if(el===inAdd) d.additions=toNumberBR(v);
      save();
      renderIncome(false);
    });
    el.addEventListener('blur',()=>{
      el.value=fmt2(toNumberBR(el.value));
    });
  });
  
  confirmIncome.addEventListener('click',()=>{
    const d=current().incomeDraft;
    const total=Number(d.payment)+Number(d.benefits)+Number(d.additions);
    if(total<=0){
      showAlert('Insira valores v√°lidos para confirmar.','warning');
      return;
    }
    current().incomeCommitted+=total;
    d.payment=0;d.benefits=0;d.additions=0;
    save();
    refresh(true);
    showAlert(`Receita de ${fmt(total)} confirmada com sucesso!`,'success');
  });
  
  clearIncome.addEventListener('click',()=>{
    const d=current().incomeDraft;
    d.payment=d.benefits=d.additions=0;
    save();
    refresh(true);
  });
  
  // Expenses
  expDate.value=new Date().toISOString().slice(0,10);
  expSubmit.addEventListener('click',()=>{
    const desc=(expDesc.value||'').trim();
    const amount=toNumberBR(expVal.value);
    const date=expDate.value;
    
    if(!desc || amount<=0 || !date){
      showAlert('Preencha todos os campos obrigat√≥rios!','warning');
      return;
    }
    
    const e={
      id:editingExpId||uid(),
      description:desc,
      amount:amount,
      date:date,
      tagId:expTag.value||null
    };
    
    if(editingExpId){
      const ix=current().expenses.findIndex(x=>x.id===editingExpId);
      if(ix>=0) current().expenses[ix]=e;
      showAlert('Despesa atualizada com sucesso!','success');
    }else{
      current().expenses.unshift(e);
      showAlert('Despesa adicionada com sucesso!','success');
    }
    
    editingExpId=null;
    expDesc.value='';
    expVal.value='';
    expDate.value=new Date().toISOString().slice(0,10);
    expTag.value=store.tags[0]?.id||'';
    expSubmit.textContent='+ Adicionar';
    expCancel.style.display='none';
    save();
    refresh(false);
  });
  
  expCancel.addEventListener('click',()=>{
    editingExpId=null;
    expSubmit.textContent='+ Adicionar';
    expCancel.style.display='none';
    expDesc.value='';
    expVal.value='';
    expDate.value=new Date().toISOString().slice(0,10);
    expTag.value=store.tags[0]?.id||'';
  });
  
  filterTag.addEventListener('change',()=>refresh(false));
  search.addEventListener('input',()=>refresh(false));
  
  // Investments
  invDate.value=new Date().toISOString().slice(0,10);
  invSubmit.addEventListener('click',()=>{
    const desc=(invDesc.value||'').trim();
    const amount=toNumberBR(invVal.value);
    const date=invDate.value;
    
    if(!desc || amount<=0 || !date){
      showAlert('Preencha todos os campos obrigat√≥rios!','warning');
      return;
    }
    
    const i={
      id:editingInvId||uid(),
      description:desc,
      category:invCat.value||'Outros',
      amount:amount,
      date:date,
      broker:(invBroker.value||'').trim()
    };
    
    if(editingInvId){
      const ix=current().investments.findIndex(x=>x.id===editingInvId);
      if(ix>=0) current().investments[ix]=i;
      showAlert('Investimento atualizado com sucesso!','success');
    }else{
      current().investments.unshift(i);
      showAlert('Investimento adicionado com sucesso!','success');
    }
    
    editingInvId=null;
    invDesc.value='';
    invVal.value='';
    invDate.value=new Date().toISOString().slice(0,10);
    invBroker.value='';
    invSubmit.textContent='+ Adicionar';
    invCancel.style.display='none';
    save();
    refresh(false);
  });
  
  invCancel.addEventListener('click',()=>{
    editingInvId=null;
    invSubmit.textContent='+ Adicionar';
    invCancel.style.display='none';
    invDesc.value='';
    invVal.value='';
    invDate.value=new Date().toISOString().slice(0,10);
    invBroker.value='';
  });
  
  filterCat.addEventListener('change',()=>refresh(false));
  searchInv.addEventListener('input',()=>refresh(false));
  countInvest.addEventListener('change',()=>{
    store.countInvestAsExpense=countInvest.checked;
    save();
    refresh(false);
  });
  
  // Tags Admin
  tagsBtn.addEventListener('click',()=>{
    editingTagId=null;
    $("#tagName").value='';
    $("#tagColor").value='#2563eb';
    renderTagTable();
    $("#dlgTags").showModal();
  });
  
  $("#tagSave").addEventListener('click',()=>{
    const name=$("#tagName").value.trim()||'Nova Tag';
    const color=$("#tagColor").value||'#2563eb';
    
    if(editingTagId){
      const t=store.tags.find(x=>x.id===editingTagId);
      if(t){t.name=name;t.color=color;}
      showAlert('Tag atualizada!','success');
    }else{
      store.tags.unshift({id:uid(),name,color});
      showAlert('Tag criada!','success');
    }
    
    editingTagId=null;
    $("#tagName").value='';
    $("#tagColor").value='#2563eb';
    save();
    renderTagTable();
    renderTags();
    refresh(false);
  });
  
  function renderTagTable(){
    const tbody=$("#tagTable");
    tbody.innerHTML=store.tags.map(t=>`<tr>
      <td><span class="badge"><span class="dot" style="background:${t.color}"></span>${esc(t.name)}</span></td>
      <td><code class="muted" style="font-size:11px">${t.color}</code></td>
      <td class="right">
        <button class="btn ghost icon" data-tedit="${t.id}">‚úèÔ∏è</button>
        <button class="btn ghost icon" data-tdel="${t.id}">üóëÔ∏è</button>
      </td>
    </tr>`).join('')||'<tr><td colspan="3" class="muted" style="text-align:center;padding:20px">Nenhuma tag cadastrada.</td></tr>';
    
    tbody.querySelectorAll('[data-tedit]').forEach(b=>b.addEventListener('click',()=>{
      const id=b.getAttribute('data-tedit');
      const t=store.tags.find(x=>x.id===id);
      if(!t) return;
      editingTagId=id;
      $("#tagName").value=t.name;
      $("#tagColor").value=t.color;
    }));
    
    tbody.querySelectorAll('[data-tdel]').forEach(b=>b.addEventListener('click',()=>{
      if(!confirm('Deseja realmente excluir esta tag?')) return;
      const id=b.getAttribute('data-tdel');
      store.tags=store.tags.filter(x=>x.id!==id);
      // Remove tag from expenses
      for(const k of Object.keys(store.months)){
        store.months[k].expenses=store.months[k].expenses.map(e=>e.tagId===id?{...e,tagId:null}:e);
      }
      save();
      renderTagTable();
      renderTags();
      refresh(false);
      showAlert('Tag exclu√≠da!','success');
    }));
  }
  
  // Goals
  goalsBtn.addEventListener('click',()=>{
    renderGoals();
    $("#dlgGoals").showModal();
  });
  
  $("#goalSave").addEventListener('click',()=>{
    const desc=$("#goalDesc").value.trim();
    const value=toNumberBR($("#goalValue").value);
    const months=parseInt($("#goalMonths").value)||1;
    const tagId=$("#goalTag").value||null;
    
    if(!desc || value<=0){
      showAlert('Preencha descri√ß√£o e valor v√°lidos!','warning');
      return;
    }
    
    store.goals.push({
      id:uid(),
      description:desc,
      targetValue:value,
      currentValue:0,
      months:months,
      tagId:tagId,
      createdAt:new Date().toISOString()
    });
    
    $("#goalDesc").value='';
    $("#goalValue").value='';
    $("#goalMonths").value='';
    $("#goalTag").value='';
    
    save();
    renderGoals();
    showAlert('Meta adicionada com sucesso!','success');
  });
  
  function renderGoals(){
    const container=$("#goalsList");
    if(store.goals.length===0){
      container.innerHTML='<div class="muted" style="text-align:center;padding:20px">Nenhuma meta cadastrada ainda.</div>';
      return;
    }
    
    container.innerHTML=store.goals.map(g=>{
      const percent=(g.currentValue/g.targetValue)*100;
      const tag=store.tags.find(t=>t.id===g.tagId);
      return `<div class="card" style="margin-bottom:12px">
        <div class="hd">
          <span>${esc(g.description)}</span>
          <button class="btn ghost icon" onclick="deleteGoal('${g.id}')">üóëÔ∏è</button>
        </div>
        <div class="bd grid">
          <div class="row" style="justify-content:space-between;font-size:13px">
            <span>Meta: <strong>${fmt(g.targetValue)}</strong></span>
            <span>Prazo: <strong>${g.months} meses</strong></span>
            ${tag?`<span class="badge"><span class="dot" style="background:${tag.color}"></span>${tag.name}</span>`:''}
          </div>
          <div class="progress-bar">
            <div class="progress-fill" style="width:${Math.min(percent,100)}%;background:var(--success)"></div>
          </div>
          <div class="muted" style="font-size:12px">Progresso: ${fmt(g.currentValue)} / ${fmt(g.targetValue)} (${percent.toFixed(0)}%)</div>
        </div>
      </div>`;
    }).join('');
  }
  
  window.deleteGoal=function(id){
    if(!confirm('Deseja realmente excluir esta meta?')) return;
    store.goals=store.goals.filter(g=>g.id!==id);
    save();
    renderGoals();
    showAlert('Meta exclu√≠da!','success');
  };
  
  // Recurring Expenses
  recurringBtn.addEventListener('click',()=>{
    renderRecurring();
    $("#dlgRecurring").showModal();
  });
  
  $("#recSave").addEventListener('click',()=>{
    const desc=$("#recDesc").value.trim();
    const value=toNumberBR($("#recValue").value);
    const day=parseInt($("#recDay").value)||1;
    const tagId=$("#recTag").value||null;
    
    if(!desc || value<=0){
      showAlert('Preencha descri√ß√£o e valor v√°lidos!','warning');
      return;
    }
    
    store.recurring.push({
      id:uid(),
      description:desc,
      amount:value,
      dayOfMonth:Math.min(31,Math.max(1,day)),
      tagId:tagId
    });
    
    $("#recDesc").value='';
    $("#recValue").value='';
    $("#recDay").value='';
    $("#recTag").value='';
    
    save();
    renderRecurring();
    showAlert('Despesa recorrente adicionada!','success');
  });
  
  $("#applyRecurring").addEventListener('click',()=>{
    const [y,m]=month.split('-').map(Number);
    const today=new Date();
    const currentDay=today.getDate();
    
    let added=0;
    store.recurring.forEach(r=>{
      const exists=current().expenses.some(e=>
        e.description===r.description && 
        e.amount===r.amount
      );
      
      if(!exists){
        const date=`${y}-${String(m).padStart(2,'0')}-${String(r.dayOfMonth).padStart(2,'0')}`;
        current().expenses.push({
          id:uid(),
          description:r.description,
          amount:r.amount,
          date:date,
          tagId:r.tagId
        });
        added++;
      }
    });
    
    save();
    refresh(false);
    $("#dlgRecurring").close();
    showAlert(`${added} despesa(s) recorrente(s) aplicada(s) ao m√™s!`,'success');
  });
  
  function renderRecurring(){
    const tbody=$("#recTable");
    tbody.innerHTML=store.recurring.map(r=>{
      const tag=store.tags.find(t=>t.id===r.tagId);
      const tagHtml=tag?`<span class="badge"><span class="dot" style="background:${tag.color}"></span>${tag.name}</span>`:'<span class="muted">Sem tag</span>';
      return `<tr>
        <td>${esc(r.description)}</td>
        <td><strong>${fmt(r.amount)}</strong></td>
        <td>Dia ${r.dayOfMonth}</td>
        <td>${tagHtml}</td>
        <td class="right">
          <button class="btn ghost icon" onclick="deleteRecurring('${r.id}')">üóëÔ∏è</button>
        </td>
      </tr>`;
    }).join('')||'<tr><td colspan="5" class="muted" style="text-align:center;padding:20px">Nenhuma despesa recorrente cadastrada.</td></tr>';
  }
  
  window.deleteRecurring=function(id){
    if(!confirm('Deseja realmente excluir esta despesa recorrente?')) return;
    store.recurring=store.recurring.filter(r=>r.id!==id);
    save();
    renderRecurring();
    showAlert('Despesa recorrente exclu√≠da!','success');
  };
  
  // Statistics
  statsBtn.addEventListener('click',()=>{
    renderStatistics();
    $("#dlgStats").showModal();
  });
  
  function renderStatistics(){
    const months=Object.keys(store.months).sort();
    $("#statTotalMonths").textContent=months.length;
    
    let totalExp=0,totalInv=0;
    months.forEach(m=>{
      const data=store.months[m];
      totalExp+=data.expenses.reduce((s,e)=>s+Number(e.amount||0),0);
      totalInv+=data.investments.reduce((s,i)=>s+Number(i.amount||0),0);
    });
    $("#statTotalExp").textContent=fmt(totalExp);
    $("#statTotalInv").textContent=fmt(totalInv);
    
    // Evolution chart
    const chartEv=$("#chartEvolution");
    while(chartEv.firstChild) chartEv.removeChild(chartEv.firstChild);
    
    const last6=months.slice(-6);
    if(last6.length<2){
      const txt=document.createElementNS(chartEv.namespaceURI,"text");
      txt.setAttribute("x","300");txt.setAttribute("y","125");txt.setAttribute("text-anchor","middle");
      txt.setAttribute("font-size","14");txt.setAttribute("fill","#94a3b8");
      txt.textContent="Dados insuficientes (m√≠nimo 2 meses)";
      chartEv.appendChild(txt);
    }else{
      const W=600,H=250,pad=50;
      const innerW=W-pad*2,innerH=H-pad*2;
      
      const values=last6.map(m=>{
        const data=store.months[m];
        const exp=data.expenses.reduce((s,e)=>s+Number(e.amount||0),0);
        const inv=data.investments.reduce((s,i)=>s+Number(i.amount||0),0);
        return {month:m,expense:exp,investment:inv};
      });
      
      const maxVal=Math.max(1,...values.map(v=>Math.max(v.expense,v.investment)));
      const stepX=innerW/(values.length-1);
      
      // Grid lines
      for(let i=0;i<=4;i++){
        const y=pad+innerH*(i/4);
        const line=document.createElementNS(chartEv.namespaceURI,"line");
        line.setAttribute("x1",pad);line.setAttribute("y1",y);
        line.setAttribute("x2",W-pad);line.setAttribute("y2",y);
        line.setAttribute("stroke","#e2e8f0");line.setAttribute("stroke-width","1");
        chartEv.appendChild(line);
      }
      
      // Lines
      function drawLine(data,color){
        let pathD='';
        data.forEach((val,i)=>{
          const x=pad+i*stepX;
          const y=pad+innerH-(val/maxVal)*innerH;
          pathD+=`${i===0?'M':'L'} ${x} ${y} `;
        });
        const path=document.createElementNS(chartEv.namespaceURI,"path");
        path.setAttribute("d",pathD);
        path.setAttribute("stroke",color);
        path.setAttribute("stroke-width","3");
        path.setAttribute("fill","none");
        chartEv.appendChild(path);
        
        // Points
        data.forEach((val,i)=>{
          const x=pad+i*stepX;
          const y=pad+innerH-(val/maxVal)*innerH;
          const circle=document.createElementNS(chartEv.namespaceURI,"circle");
          circle.setAttribute("cx",x);circle.setAttribute("cy",y);circle.setAttribute("r","5");
          circle.setAttribute("fill",color);
          chartEv.appendChild(circle);
        });
      }
      
      drawLine(values.map(v=>v.expense),"#ea580c");
      drawLine(values.map(v=>v.investment),"#16a34a");
      
      // Labels
      values.forEach((v,i)=>{
        const x=pad+i*stepX;
        const label=new Date(v.month+'-01').toLocaleDateString('pt-BR',{month:'short'});
        const txt=document.createElementNS(chartEv.namespaceURI,"text");
        txt.setAttribute("x",x);txt.setAttribute("y",H-pad+22);
        txt.setAttribute("text-anchor","middle");txt.setAttribute("font-size","13");
        txt.setAttribute("font-weight","600");txt.setAttribute("fill","#475569");
        txt.textContent=label;
        chartEv.appendChild(txt);
      });
      
      // Legend
      const leg1=document.createElementNS(chartEv.namespaceURI,"text");
      leg1.setAttribute("x","25");leg1.setAttribute("y","25");
      leg1.setAttribute("font-size","14");leg1.setAttribute("font-weight","600");leg1.setAttribute("fill","#ea580c");
      leg1.textContent="‚óè Despesas";chartEv.appendChild(leg1);
      
      const leg2=document.createElementNS(chartEv.namespaceURI,"text");
      leg2.setAttribute("x","25");leg2.setAttribute("y","45");
      leg2.setAttribute("font-size","14");leg2.setAttribute("font-weight","600");leg2.setAttribute("fill","#16a34a");
      leg2.textContent="‚óè Investimentos";chartEv.appendChild(leg2);
    }
    
    // Top tags
    const tagTotals={};
    months.forEach(m=>{
      store.months[m].expenses.forEach(e=>{
        const tag=store.tags.find(t=>t.id===e.tagId);
        const name=tag?tag.name:'Sem tag';
        tagTotals[name]=(tagTotals[name]||0)+Number(e.amount||0);
      });
    });
    const topTags=Object.entries(tagTotals).sort((a,b)=>b[1]-a[1]).slice(0,5);
    $("#topTagsList").innerHTML=topTags.map(([name,val])=>`
      <div class="row" style="justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border)">
        <span>${esc(name)}</span>
        <strong>${fmt(val)}</strong>
      </div>
    `).join('')||'<div class="muted">Nenhum dado dispon√≠vel</div>';
    
    // Comparison with previous month
    const currentIdx=months.indexOf(month);
    if(currentIdx>0){
      const prevMonth=months[currentIdx-1];
      const curr=store.months[month];
      const prev=store.months[prevMonth];
      
      const currExp=curr.expenses.reduce((s,e)=>s+Number(e.amount||0),0);
      const prevExp=prev.expenses.reduce((s,e)=>s+Number(e.amount||0),0);
      const diffExp=currExp-prevExp;
      const pctExp=prevExp>0?((diffExp/prevExp)*100):0;
      
      const currInv=curr.investments.reduce((s,i)=>s+Number(i.amount||0),0);
      const prevInv=prev.investments.reduce((s,i)=>s+Number(i.amount||0),0);
      const diffInv=currInv-prevInv;
      const pctInv=prevInv>0?((diffInv/prevInv)*100):0;
      
      $("#comparisonList").innerHTML=`
        <div style="padding:10px 0;border-bottom:1px solid var(--border)">
          <div class="row" style="justify-content:space-between;margin-bottom:4px">
            <span>Despesas</span>
            <strong style="color:${diffExp>0?'var(--danger)':'var(--success)'}">${diffExp>=0?'+':''}${fmt(diffExp)}</strong>
          </div>
          <div class="muted" style="font-size:12px">${pctExp>=0?'+':''}${pctExp.toFixed(1)}% em rela√ß√£o ao m√™s anterior</div>
        </div>
        <div style="padding:10px 0">
          <div class="row" style="justify-content:space-between;margin-bottom:4px">
            <span>Investimentos</span>
            <strong style="color:${diffInv<0?'var(--danger)':'var(--success)'}">${diffInv>=0?'+':''}${fmt(diffInv)}</strong>
          </div>
          <div class="muted" style="font-size:12px">${pctInv>=0?'+':''}${pctInv.toFixed(1)}% em rela√ß√£o ao m√™s anterior</div>
        </div>
      `;
    }else{
      $("#comparisonList").innerHTML='<div class="muted">Sem dados do m√™s anterior</div>';
    }
  }
  
  // Export/Import/Reset
  exportBtn.addEventListener('click',()=>{
    const blob=new Blob([JSON.stringify(store,null,2)],{type:'application/json'});
    const a=document.createElement('a');
    a.href=URL.createObjectURL(blob);
    a.download=`financeiro-pro-${new Date().toISOString().slice(0,10)}.json`;
    a.click();
    URL.revokeObjectURL(a.href);
    showAlert('Dados exportados com sucesso!','success');
  });
  
  importJSON.addEventListener('change',(ev)=>{
    const f=ev.target.files?.[0];
    if(!f) return;
    const r=new FileReader();
    r.onload=()=>{
      try{
        const data=JSON.parse(String(r.result));
        if(!data.tags || !data.months){
          showAlert('Arquivo JSON inv√°lido!','danger');
          return;
        }
        store=data;
        month=Object.keys(store.months).sort().reverse()[0];
        countInvest.checked=!!store.countInvestAsExpense;
        save();
        refresh(true);
        showAlert('Dados importados com sucesso!','success');
      }catch(e){
        showAlert('Erro ao importar arquivo!','danger');
      }
    };
    r.readAsText(f);
  });
  
  resetBtn.addEventListener('click',()=>{
    if(!confirm("‚ö†Ô∏è Isso ir√° RESETAR TODOS OS DADOS! Deseja continuar?")) return;
    if(!confirm("Tem certeza absoluta? Esta a√ß√£o n√£o pode ser desfeita!")) return;
    store=defaults();
    month=Object.keys(store.months)[0];
    save();
    refresh(true);
    showAlert('Todos os dados foram resetados!','info');
  });
  
  // Boot
  countInvest.checked=!!store.countInvestAsExpense;
  refresh(true);
})();
</script>
</body>
</html>